<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Auth</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Loading...</h1>

    <div id="login-ui" style="display:none; text-align:center;">
        <p>You must sign in to chat.</p>
        <button onclick="login()">Sign in with Google</button>
    </div>

    <div id="chat-ui" style="display:none; margin-top: 20px;">
        <p>Logged in as: <span id="user-email"></span> <button onclick="logout()">Logout</button></p>
        <input type="text" id="msgInput" placeholder="Type a message..." />
        <button onclick="sendMessage()">Send</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        const supabaseUrl = 'https://hqtyztqjnwpbfcbijuvb.supabase.co'
        const supabaseKey = 'sb_publishable_7vFBFbpeXCLYwo66KTb3uQ_RkQIKsMG'
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey)

        // 1. Check Session on Load
        async function checkSession() {
            const { data: { session } } = await supabaseClient.auth.getSession()
            updateUI(session)
        }

        // 2. Handle Login
        async function login() {
            await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    queryParams: {
                        access_type: 'offline',
                        prompt: 'consent',
                    },
                },
            })
        }

        // 3. Handle Logout
        async function logout() {
            await supabaseClient.auth.signOut()
            updateUI(null)
        }

        // 4. Update UI Helper
        function updateUI(session) {
            if (session) {
                document.getElementById('login-ui').style.display = 'none'
                document.getElementById('chat-ui').style.display = 'block'
                document.getElementById('user-email').innerText = session.user.email
            } else {
                document.getElementById('login-ui').style.display = 'block'
                document.getElementById('chat-ui').style.display = 'none'
            }
        }

        // --- EXISTING CHAT LOGIC ---
        async function getMessages() {
            const { data, error } = await supabaseClient
                .from('messages')
                .select()
                .order('id', { ascending: false })
                .limit(1)
            
            if (!error && data[0]) document.querySelector('h1').innerText = data[0].text
        }

        async function sendMessage() {
            const input = document.getElementById('msgInput')
            const text = input.value
            if (!text) return

            // Supabase automatically attaches the User ID now!
            const { error } = await supabaseClient.from('messages').insert({ text })
            if (error) alert(error.message)
            else input.value = ""
        }

        // Realtime Subscription
        supabaseClient
            .channel('public:messages') 
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, 
                (payload) => { document.querySelector('h1').innerText = payload.new.text }
            )
            .subscribe()

        // Init
        getMessages()
        checkSession()
    </script>
</body>
</html>